# Gatewai System Architecture

This document visualizes the high-level architecture of the Gatewai platform, illustrating the hybrid execution model, data flow, and key components.

```mermaid
graph TB
    subgraph Frontend["Frontend (Browser)"]
        style Frontend fill:#e1f5fe,stroke:#01579b,stroke-width:2px
        
        CanvasEditor["Canvas Editor<br>(React / ReactFlow)"]:::component
        NodeGraphProcessor["NodeGraphProcessor<br>(TypeScript)"]:::component
        LocalProcessors["Local Processors<br>(Browser JS)"]:::component
        
        CanvasEditor -- "User Actions" --> NodeGraphProcessor
        NodeGraphProcessor -- "Executes Light Nodes<br>(e.g. Crop, Toggle)" --> LocalProcessors
    end

    subgraph Backend["Backend (Node.js / Hono)"]
        style Backend fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
        
        APIServer["API Server<br>(Hono)"]:::component
        WorkflowWorker["Workflow Worker<br>(Node.js)"]:::component
        AgentWorker["Agent Worker / Copilot<br>(Node.js)"]:::component
        
        APIServer -- "Manages Agent Sessions" --> AgentWorker
    end

    subgraph DataLayer["Data Layer"]
        style DataLayer fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
        
        PostgreSQL[("PostgreSQL<br>(Nodes, Edges, Users)")]:::database
        ObjectStorage[("Object Storage<br>(GCS / S3)")]:::database
        Redis[("Redis<br>(Queue / Cache)")]:::database
    end

    subgraph External["External Services"]
        style External fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
        
        MCPServer["MCP Server<br>(Context Providers)"]:::external
    end

    %% Key Interactions
    NodeGraphProcessor <-->|"Syncs Graph State<br>& Requests Execution"| APIServer
    
    %% Queue Interaction (BullMQ)
    APIServer -- "Enqueues Jobs<br>(BullMQ)" --> Redis
    WorkflowWorker -- "Processes Jobs<br>(BullMQ)" --> Redis

    %% Backend Data Access
    APIServer -- "CRUD" --> PostgreSQL
    WorkflowWorker -- "Updates Status / Logs" --> PostgreSQL
    AgentWorker -- "Reads/Writes Sessions" --> PostgreSQL
    
    %% Asset Flow
    WorkflowWorker -- "Uploads Generated Media" --> ObjectStorage
    NodeGraphProcessor -. "Fetches Assets (Signed URLs)" .-> ObjectStorage
    
    %% Agent Interactions
    AgentWorker <-->|"MCP Protocol<br>(Tool Use / Context)"| MCPServer
    
    %% Styling Classes
    classDef component fill:#ffffff,stroke:#333,stroke-width:1px
    classDef database fill:#ffffff,stroke:#333,stroke-width:1px
    classDef external fill:#ffffff,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
```

## Component Overview

### Frontend (Browser)
- **Canvas Editor**: The primary UI for constructing generative workflows.
- **NodeGraphProcessor**: The client-side engine that orchestrates execution. It identifies which nodes can be run locally and which must be offloaded to the server.
- **Local Processors**: Performs lightweight operations (e.g., cropping, boolean logic) directly in the browser to reduce latency.

### Backend (Node.js/Hono)
- **API Server**: The central entry point for authentication, graph management, and session handling.
- **Workflow Worker**: A dedicated background worker for executing resource-intensive "Terminal Nodes" (e.g., ImageGen, VideoGen). It consumers jobs from the Redis queue.
- **Agent Worker (Copilot)**: Manages usage of the AI Agent (Copilot) for tasks like "Patch this canvas" or answering questions. Interacts with the MCP server.

### External Services
- **MCP Server**: Implements the Model Context Protocol to provide the Agent with tools and context about the codebase or external systems.

### Data Layer
- **PostgreSQL**: The source of truth for all structured data (users, canvases, node configurations).
- **Redis (BullMQ)**: Handles the asynchronous task queue for the Workflow Worker, ensuring reliable execution and retries for generative tasks.
- **Object Storage**: High-capacity storage for media assets (images, videos) generated by the workflow.
