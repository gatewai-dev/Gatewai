name: Deploy to GCE

on:
  push:
    tags:
      - "v*"

env:
  PROJECT_ID: gatewai-466716
  GAR_LOCATION: us-central1
  REPOSITORY: gatewai
  IMAGE_APP: gatewai-app
  IMAGE_MCP: gatewai-mcp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Docker Auth'
        run: |-
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build and Push App
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:${{ github.sha }}

      - name: Build and Push MCP
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.mcp
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GCE via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCE_INSTANCE_IP }}
          username: gatewai
          key: ${{ secrets.GCE_SSH_PRIVATE_KEY }}
          script: |
            cd /home/gatewai/gc-hackathon
            git pull origin main
            gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev
            ./scripts/setup-env-gce.sh
            docker compose pull
            docker compose run --rm app npx prisma migrate deploy --schema ./packages/db/prisma/schema.prisma
            docker compose up -d --remove-orphans

