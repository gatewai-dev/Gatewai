name: Deploy to GCE

on:
  push:
    tags:
      - "v*"

env:
  PROJECT_ID: gatewai-466716
  GAR_LOCATION: us-central1
  REPOSITORY: gatewai
  IMAGE_APP: gatewai-app
  IMAGE_MCP: gatewai-mcp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Docker Auth'
        run: |-
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build and Push App
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:${{ github.sha }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:${{ github.ref_name }}

      - name: Build and Push MCP
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.mcp
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:${{ github.sha }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:${{ github.ref_name }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Instead of cloning on the server, we send the compose and script files directly
      - name: Copy files to GCE
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCE_INSTANCE_IP }}
          username: okanasl
          key: ${{ secrets.GCE_SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,scripts/setup-env-gce.sh"
          target: "/home/okanasl/gatewai"

      - name: Deploy to GCE via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCE_INSTANCE_IP }}
          username: okanasl
          key: ${{ secrets.GCE_SSH_PRIVATE_KEY }}
          envs: GAR_LOCATION,PROJECT_ID,REPOSITORY,IMAGE_APP,IMAGE_MCP
          script: |
            PROJECT_DIR="/home/okanasl/gatewai"
            cd "$PROJECT_DIR"

            # 1. Authenticate Docker with Google Artifact Registry
            # Ensure the VM has the 'Artifact Registry Reader' role assigned
            gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

            # 2. Setup Environment
            chmod +x ./scripts/setup-env-gce.sh
            ./scripts/setup-env-gce.sh
            
            # Export tag for docker compose
            export IMAGE_TAG=${{ github.ref_name }}
            
            # 3. Pull and Update
            docker compose pull
            
            # Run migration using the newly pulled app container
            docker compose run --rm app pnpm --filter @gatewai/db db:deploy
            
            docker compose up -d --remove-orphans

            # 4. Cleanup
            docker image prune -af