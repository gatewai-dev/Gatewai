name: Deploy to GCE

on:
  push:
    tags:
      - "v*"

env:
  PROJECT_ID: gatewai-466716
  GAR_LOCATION: us-central1
  REPOSITORY: gatewai
  IMAGE_APP: gatewai-app
  IMAGE_MCP: gatewai-mcp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Docker Auth'
        run: |-
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build and Push App
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:${{ github.sha }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_APP }}:${{ github.ref_name }}

      - name: Build and Push MCP
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.mcp
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:${{ github.sha }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_MCP }}:${{ github.ref_name }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GCE via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCE_INSTANCE_IP }}
          username: okn.aslnkn
          key: ${{ secrets.GCE_SSH_PRIVATE_KEY }}
          script: |
            # Define the project directory
            PROJECT_DIR="/home/okanasl/gatewai"

            # Fix git ownership issue
            git config --global --add safe.directory "$PROJECT_DIR"

            # Clone repository if it doesn't exist
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Repository not found. Cloning..."
              git clone https://github.com/${{ github.repository }}.git "$PROJECT_DIR"
            fi

            cd "$PROJECT_DIR"

            # 1. Sync the code to the triggered tag
            git fetch --tags
            git checkout ${{ github.ref_name }}

            # 2. Authenticate and Pull
            gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev
            chmod +x ./scripts/setup-env-gce.sh
            ./scripts/setup-env-gce.sh
            
            # Export tag for docker compose
            export IMAGE_TAG=${{ github.ref_name }}
            docker compose pull

            # 3. Migrate and Update Containers
            # Run migration using the app container but with pnpm command
            docker compose run --rm app pnpm --filter @gatewai/db db:deploy
            docker compose up -d --remove-orphans

            # 4. Cleanup (The Space Saver)
            # This removes all images not currently in use by the running containers
            docker image prune -af