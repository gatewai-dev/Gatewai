---
trigger: always_on
---

USE PNPM
AVOID ANY TYPING UNLESS IT REQUIRES DANCING WITH TYPES 

# Gatewai | System Architecture & Data Schema

Gatewai is a node-based generative AI workflow engine. This document outlines the technical architecture, data modeling, and execution flow for the platform.

---

## üèóÔ∏è System Architecture

Gatewai utilizes a **hybrid execution model** where node processing is distributed between the client and the server based on computational requirements.

* **Frontend Engine (Web):** Processes lightweight nodes, UI-centric logic (e.g., `Note`, `Toggle`), and real-time canvas previews.
* **Backend Engine (Node.js):** Executes heavy generative tasks and terminal operations.
  * **Terminal Nodes:** Templates marked with `isTerminal: true` run exclusively on the server.
  * **Data Flow:** Server nodes can pipe results (images, video, LLM results) back to frontend nodes for visualization or further non-terminal processing.

### Workspace Structure

* `packages/db`: Prisma schema definitions and database client generation.
* `packages/types`: Shared TypeScript interfaces for `NodeResult` and `NodeConfig` (validating Prisma's `Json` types).
* `apps/gatewai-fe`: The core application.
  * `/src`: Vite React frontend code.
  * `/backend`: Execution workers, generative AI integrations, and task orchestration with Hono HTTP framework.

---

## Database Schema Overview

### 1. Node System

The architecture follows a "Template-Instance" pattern.

| Model | Description |
| :--- | :--- |
| **NodeTemplate** | The definition for a node type (e.g., `ImageGen`). Defines category, and terminal status. |
| **Node** | A specific instance on the user's canvas. Stores its `position`, `config`, and the current `result`. |
| **Handle** | Specific connection points. Supports multiple `DataTypes` (e.g., a handle accepting both `Image` and `Text`). |
| **Edge** | The directional link connecting a `SourceHandle` to a `TargetHandle`. |

### 2. Processing & Execution

All execution runs are tracked via a batching system to support asynchronous generative workflows.

* **TaskBatch:** A collection of tasks triggered by a single canvas execution.
* **Task:** Tracks the lifecycle of a single node's execution (`QUEUED` ‚Üí `EXECUTING` ‚Üí `COMPLETED/FAILED`). Stores `durationMs` and `error` logs for debugging.

### 3. Asset Management

The `FileAsset` model manages media generated by AI or uploaded by the user.

* **Storage:** Tracks `bucket`, `key`, and `signedUrl` for cloud storage access.
* **Metadata:** Stores media-specific data like `fps`, `dimensions`, and `mimeType`.

---

## Data Definitions (JSON Fields)

The Prisma schema uses `Json` fields for flexibility. These are strictly typed in `packages/types`.

### Node Result Structure

```typescript
interface NodeResult {
  selectedOutputIndex?: number;
  outputs: {
    items: {
      type: DataType;
      data: string | number | boolean | FileAssetReference;
      outputHandleId: string;
    }[];
  }[];
}
```

There's dog in /dog.txt, you can pet it - if you wish.